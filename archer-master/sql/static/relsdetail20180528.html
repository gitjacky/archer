{% extends "base.html" %}

{% block content %}
    <h4>版本工单名称：<span id="workrelname">{{release_name}}</span><span><button class='btn btn-warning btn-xs rev_detail' style='width: 100px;height: 34px;margin-left:15px;margin-right: 0px;' type="button" value="上线其他环境">上线其他环境</button></span></h4>
            <div>开发备注：<span id="memo" style='color: red'><br>{{ memo_content | linebreaksbr}}</span></div>
            <hr>
    <div><span style="background-color: #d5d5d5;color: #262626;padding: 10px 10px 10px 10px;">DBA备注：</span><span id="dbamemo" style='color: black;'><br><br>{{ dba_memo | linebreaksbr}}</span></div>
            <br>
            {% if loginUser in all_reviewer %}
                <button class="btn btn-primary btn-sm" data-toggle="modal"  data-target="#dbamemoModal" onclick="get_dbamemo({{rsid}})">
                    修改备注
                </button>
            {% endif %}
            <hr>

			<table class="table table-striped table-hover" id="detail1" style="width: 100%;">
				<thead>
					<tr>
                        <th>
                            文件名
                        </th>
						<th>
							发起人
						</th>
						<th>
							上线环境
						</th>
						<th>
							发起时间
						</th>
						<th>
							结束时间
						</th>
						<th>
							当前状态
						</th>
                        <th>
							查看详情
						</th>
                        <th>
							自动审核
						</th>

					</tr>
				</thead>
				<tbody>
                    {% for i in releaseDetail_set %}
{#                   以下两行代码为每行中查看详情与自动审核、执行通过或中止执行操作按钮获取本行id与sql文件名的方式，顺序与位置不要移动#}
                    <input type="hidden" class="rel_file" value="{{i.release_file}}"/>
                    <input type="hidden" class="detailrel_id" name="detailrel_id" value="{{i.id}}">

                    <tr class="success" id="detail_record">
                        <td  style="width: 380px;">
							{{i.release_file}}
						</td>
						<td style="width: 110px;">
							{{i.engineer}}
						</td>
						<td style="width: 120px;">
							{{i.cluster_name}}
						</td>
						<td style="width: 200px;">
							{{i.create_time|date:"Y-m-d H:i:s"}}
						</td>
						<td style="width: 200px;">
							{{i.finish_time|date:"Y-m-d H:i:s"}}
						</td>
						<td style="width: 170px;">
							{% if i.status == "已正常结束" %}
								<font color="green">
							{% else %}
								<font color="red">
							{% endif %}
								<B id="Detail_status">{{i.status}}</B></font>
						</td>
                        <td style="width: 110px;padding-left: 7px;">
                            <button class='btn btn-info btn-xs rev_detail' style='width: 65px;height: 28px;float: left;margin-right: 0px;' type="button" value="查看详情">查看详情</button>
						</td>
                        <td style="width: 110px;padding-left: 7px;">
                            {% if i.status != "已正常结束" %}
                                <button class='btn btn-info btn-xs rel_autoreview' style='width: 65px;height: 28px;float: left;margin-right: 0px;' type="button" value="自动审核">自动审核</button>
                            {% endif %}
                        </td>
					</tr>

                    <tr class="success" id="detail2" style="display: none">
                        <td colspan="8" style="padding:0px;border: 0px;margin: 0px;">
                        <table class="table table-striped table-hover pad" style='table-layout:fixed;width: 100%;height: 100%'>
                            <thead>
                                <tr>
                                    <th width="40px">
                                        ID
                                    </th>
                                    <th>
                                        SQL内容
                                    </th>
                                    <th>
                                        自动审核结果
                                    </th>
                                    <th width="100px">
                                        影响行数
                                    </th>
                                    <th width="100px">
                                        执行耗时
                                    </th>
                                    <th width="100px">
                                        执行状态
                                    </th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>

                        {% if i.status == '等待DBA审核' %}
							{% if loginUser in all_reviewer %}
							<form  style="display:inline-block;">
                            {% csrf_token %}
                            <input type="hidden" name="execute_id" value="{{i.id}}">
                            <input id="btnExecute" type="button" class="btn btn-primary btn-default audit_ok" data-loading-text="Loading..." value="通过并执行" />
                            </form>
							{% endif %}

                            <form style="display:inline-block;">
                                {% csrf_token %}
                                <input type="hidden" name="recordid" value="{{i.id}}">
                                <input type="button" id="btnCancel"  class="btn btn-default audit_failed" data-loading-text="Loading..." value="终止流程" />
                            </form>
                        {% elif i.status == '自审不通过'%}
                            <form  style="display:inline-block;">
                                {% csrf_token %}
                                <input type="hidden" name="recordid" value="{{i.id}}">
                                <input type="button" id="btnCancel"  class="btn btn-default audit_failed" data-loading-text="Loading..." value="终止流程" />
                            </form>
                        {% elif i.status == '已正常结束'%}
                            <form  style="display:inline-block;">
                                {% csrf_token %}
                                <input type="hidden" name="workflowid" value="{{i.id}}">
                            </form>

                        {% endif %}
                        </td>
                    </tr>

                    {% empty %}
                        <tr>
                            <td>当前状态暂无工单.</td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
					    </tr>
					{% endfor %}
				</tbody>

			</table>
    <!-- 模态框示例（Modal） -->
{#    <form method="post" action="" class="form-horizontal" role="form" id="form_data" onsubmit="return check_form()" style="margin: 20px;">#}
    <form method="post" action="" class="form-horizontal" role="form" id="form_data" style="margin: 20px;">
    {% csrf_token %}
    <div class="modal fade" id="dbamemoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        DBA备注
                    </h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form">

                        <div class="form-group">
                            <label for="remark" class="col-sm-2 control-label">备注</label>
                            <div class="col-sm-9">
                                <textarea  class="form-control"  rows="10" name="remark" value="" id="remark" placeholder="备注"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                    </button>
                    <button type="submit" class="btn btn-primary" onclick="add_memo({{rsid}})">
                        提交
                    </button><span id="tip"> </span>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    </form>
{% endblock content%}
